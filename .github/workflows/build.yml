name: build-sqlcipher

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

env:
  OPENSSL_VERSION: 3.2.1

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - os: ubuntu-22.04
            arch: amd64
            host: x86_64-linux-gnu
          - os: ubuntu-22.04
            arch: arm64
            host: aarch64-linux-gnu

          # macOS
          - os: macos-15-intel
            arch: amd64
            host: x86_64-apple-darwin
          - os: macos-15
            arch: arm64
            host: aarch64-apple-darwin

          # Windows
          - os: windows-latest
            arch: x64
            msys-env: mingw64
            host: x86_64-w64-mingw32
          - os: windows-latest
            arch: x86
            msys-env: mingw32
            host: i686-w64-mingw32

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      # ---------- Linux deps ----------
      - name: Install deps (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo dpkg --add-architecture arm64
          sudo apt-get update
          sudo apt-get install -y \
            build-essential pkg-config tcl git \
            crossbuild-essential-arm64 libc6-dev-arm64-cross \
            qemu-user-static

      # ---------- macOS deps ----------
      - name: Install deps (macOS)
        if: startsWith(matrix.os, 'macos')
        run: |
          brew update
          brew install tcl-tk pkg-config

      # ---------- Windows deps ----------
      - name: Set up MSYS2
        if: startsWith(matrix.os, 'windows')
        uses: msys2/setup-msys2@v2
        with:
          update: true
          msystem: ${{ matrix.msys-env }}
          install: >-
            git autoconf automake libtool make
            mingw-w64-${{ matrix.arch == 'x64' && 'x86_64' || 'i686' }}-toolchain
            mingw-w64-${{ matrix.arch == 'x64' && 'x86_64' || 'i686' }}-pkg-config

      - name: Prepare env
        shell: bash
        run: |
          echo "PREFIX=$PWD/out/${{ matrix.os }}-${{ matrix.arch }}" >> $GITHUB_ENV
          echo "HOST=${{ matrix.host }}" >> $GITHUB_ENV
          mkdir -p "$PREFIX"

      # ---------- Fetch sources ----------
      - name: Fetch SQLCipher
        shell: bash
        run: |
          mkdir -p deps
          cd deps
          git clone https://github.com/sqlcipher/sqlcipher.git
          cd sqlcipher
          git checkout v4.5.6

      # ---------- Build OpenSSL (static only) ----------
      - name: Build OpenSSL (static)
        shell: bash
        run: |
          cd deps
          git clone --depth=1 --branch=openssl-${OPENSSL_VERSION} https://github.com/openssl/openssl.git
          cd openssl

          if [[ "${{ matrix.host }}" == *darwin* ]]; then
            TARGET="${{ matrix.arch == 'arm64' && 'darwin64-arm64-cc' || 'darwin64-x86_64-cc' }}"
          elif [[ "${{ matrix.host }}" == *mingw* ]]; then
            TARGET="mingw64"
          else
            TARGET="${{ matrix.host }}"
          fi

          ./Configure $TARGET no-shared no-tests --prefix="$PREFIX/openssl"
          make -j$(nproc 2>/dev/null || sysctl -n hw.ncpu)
          make install_sw

          echo "PKG_CONFIG_PATH=$PREFIX/openssl/lib/pkgconfig" >> $GITHUB_ENV
          echo "CPPFLAGS=-I$PREFIX/openssl/include" >> $GITHUB_ENV
          echo "LDFLAGS=-L$PREFIX/openssl/lib" >> $GITHUB_ENV

      # ---------- Build SQLCipher ----------
      - name: Build SQLCipher
        shell: bash
        working-directory: deps/sqlcipher
        run: |
          if [[ "${{ matrix.host }}" == "aarch64-linux-gnu" ]]; then
            export CC=aarch64-linux-gnu-gcc
            export AR=aarch64-linux-gnu-ar
            export RANLIB=aarch64-linux-gnu-ranlib
            export PKG_CONFIG_LIBDIR=/usr/lib/aarch64-linux-gnu/pkgconfig
          fi

          if [[ "${{ matrix.os }}" == windows* ]]; then
            export LIBS="$(pkg-config --static --libs openssl) -lws2_32 -lcrypt32"
            TCL_OPT="--disable-tcl"
          else
            export LIBS="$(pkg-config --static --libs openssl)"
            TCL_OPT=""
          fi

          ./configure \
            --host="${{ matrix.host }}" \
            --prefix="$PREFIX" \
            --enable-static=yes \
            --disable-shared \
            --enable-tempstore=yes \
            --with-crypto-lib=openssl \
            $TCL_OPT \
            CFLAGS="-DSQLITE_HAS_CODEC -DSQLITE_TEMP_STORE=2" \
            CPPFLAGS="$CPPFLAGS" \
            LDFLAGS="$LDFLAGS"

          make -j$(nproc 2>/dev/null || sysctl -n hw.ncpu)
          make install

      # ---------- Verify ----------
      - name: Verify no dynamic OpenSSL
        shell: bash
        run: |
          nm "$PREFIX/lib/libsqlcipher.a" | grep -i ssl || echo "OK: no dynamic ssl symbols"

      # ---------- Package ----------
      - name: Package
        shell: bash
        run: |
          tar czf sqlcipher-${{ matrix.os }}-${{ matrix.arch }}.tar.gz -C "$PREFIX" .
          mkdir -p artifacts
          mv sqlcipher-${{ matrix.os }}-${{ matrix.arch }}.tar.gz artifacts/

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: sqlcipher-${{ matrix.os }}-${{ matrix.arch }}
          path: artifacts/sqlcipher-${{ matrix.os }}-${{ matrix.arch }}.tar.gz