name: build-sqlcipher

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - os: ubuntu-22.04
            arch: amd64
            host: x86_64-linux-gnu
          - os: ubuntu-22.04
            arch: arm64
            host: aarch64-linux-gnu
          # macOS
          - os: macos-13
            arch: amd64
            host: x86_64-apple-darwin
          - os: macos-14
            arch: arm64
            host: arm64-apple-darwin
          # Windows (MSYS2 mingw)
          - os: windows-latest
            arch: x64
            msys-env: mingw64
            host: x86_64-w64-mingw32
          - os: windows-latest
            arch: x86
            msys-env: mingw32
            host: i686-w64-mingw32

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      # ---------- Linux deps ----------
      - name: Install deps (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config tcl git \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            libssl-dev || true

      # ---------- macOS deps ----------
      - name: Install deps (macOS)
        if: startsWith(matrix.os, 'macos')
        run: |
          brew update
          brew install openssl@3 tcl-tk pkg-config
          echo "PKG_CONFIG_PATH=$(brew --prefix openssl@3)/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV

      # ---------- Windows deps (MSYS2 + mingw) ----------
      - name: Set up MSYS2
        if: startsWith(matrix.os, 'windows')
        uses: msys2/setup-msys2@v2
        with:
          update: true
          msystem: ${{ matrix.msys-env }}
          install: >-
            git
            mingw-w64-${{ matrix.arch == 'x64' && 'x86_64' || 'i686' }}-toolchain
            mingw-w64-${{ matrix.arch == 'x64' && 'x86_64' || 'i686' }}-openssl
            mingw-w64-${{ matrix.arch == 'x64' && 'x86_64' || 'i686' }}-pkg-config
            mingw-w64-${{ matrix.arch == 'x64' && 'x86_64' || 'i686' }}-tcl

      - name: Prepare env
        shell: bash
        run: |
          echo "HOST=${{ matrix.host }}" >> $GITHUB_ENV
          echo "PREFIX=$PWD/out/${{ matrix.os }}-${{ matrix.arch }}" >> $GITHUB_ENV
          mkdir -p out/${{ matrix.os }}-${{ matrix.arch }}

      - name: Fetch SQLCipher
        shell: bash
        run: |
          mkdir -p deps && cd deps
          if [ ! -d sqlcipher ]; then
            git clone https://github.com/sqlcipher/sqlcipher.git
          fi
          cd sqlcipher
          git checkout v4.5.6  # 如需版本调整在此改

      # ---------- Bootstrap OpenSSL if missing (Linux/macOS) ----------
      - name: Bootstrap OpenSSL (Unix)
        if: ${{ !startsWith(matrix.os, 'windows') }}
        shell: bash
        env:
          PREFIX: ${{ env.PREFIX }}
        run: |
          set -e
          # 若 pkg-config 找不到 openssl，构建自带静态 openssl
          if ! pkg-config --exists openssl; then
            echo "OpenSSL not found, building from source..."
            mkdir -p deps && cd deps
            if [ ! -d openssl-src ]; then
              git clone --depth=1 --branch=openssl-3.2.1 https://github.com/openssl/openssl.git openssl-src
            fi
            cd openssl-src
            ./Configure no-shared --prefix="${PREFIX}/openssl" $(uname | tr '[:upper:]' '[:lower:]')-$(uname -m)
            make -j$(nproc 2>/dev/null || sysctl -n hw.ncpu)
            make install_sw
            echo "PKG_CONFIG_PATH=${PREFIX}/openssl/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          else
            echo "System OpenSSL detected."
          fi

      # ---------- Build on Linux/macOS ----------
      - name: Configure & Build (Unix)
        if: ${{ !startsWith(matrix.os, 'windows') }}
        working-directory: deps/sqlcipher
        env:
          PREFIX: ${{ env.PREFIX }}
          HOST: ${{ env.HOST }}
        shell: bash
        run: |
          if [[ "$HOST" == "aarch64-linux-gnu" ]]; then
            export CC=aarch64-linux-gnu-gcc
            export AR=aarch64-linux-gnu-ar
            export RANLIB=aarch64-linux-gnu-ranlib
          fi
          ./configure \
            --host="${HOST}" \
            --prefix="${PREFIX}" \
            --enable-tempstore=yes \
            --enable-static=yes \
            --disable-shared \
            --with-crypto-lib=openssl \
            CFLAGS="-DSQLITE_HAS_CODEC -DSQLITE_TEMP_STORE=2" \
            LIBS="$(pkg-config --libs openssl)"
          make -j$(nproc 2>/dev/null || sysctl -n hw.ncpu)
          make install

      # ---------- Bootstrap OpenSSL if missing (Windows MSYS2) ----------
      - name: Bootstrap OpenSSL (Windows)
        if: startsWith(matrix.os, 'windows')
        shell: msys2 {0}
        env:
          PREFIX: ${{ env.PREFIX }}
        run: |
          set -e
          if ! pkg-config --exists openssl; then
            echo "OpenSSL not found in MSYS2 environment. Please ensure mingw openssl package is installed."
            exit 1
          fi

      # ---------- Build on Windows (MSYS2 mingw) ----------
      - name: Configure & Build (Windows mingw)
        if: startsWith(matrix.os, 'windows')
        shell: msys2 {0}
        working-directory: deps/sqlcipher
        env:
          PREFIX: ${{ env.PREFIX }}
          HOST: ${{ env.HOST }}
        run: |
          export CC=${HOST}-gcc
          export AR=${HOST}-ar
          export RANLIB=${HOST}-ranlib
          PKG_CONFIG_PATH="/mingw${{ matrix.arch == 'x64' && '64' || '' }}/lib/pkgconfig"
          ./configure \
            --host="${HOST}" \
            --prefix="${PREFIX}" \
            --enable-tempstore=yes \
            --enable-static=yes \
            --disable-shared \
            --with-crypto-lib=openssl \
            CFLAGS="-DSQLITE_HAS_CODEC -DSQLITE_TEMP_STORE=2" \
            LIBS="$(PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --libs openssl)"
          make -j$(nproc || 2)
          make install

      - name: Package artifacts
        shell: bash
        run: |
          ls -R "${PREFIX}"
          tar czf sqlcipher-${{ matrix.os }}-${{ matrix.arch }}.tar.gz -C "${PREFIX}" .
          mkdir -p artifacts
          mv sqlcipher-${{ matrix.os }}-${{ matrix.arch }}.tar.gz artifacts/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sqlcipher-${{ matrix.os }}-${{ matrix.arch }}
          path: artifacts/sqlcipher-${{ matrix.os }}-${{ matrix.arch }}.tar.gz