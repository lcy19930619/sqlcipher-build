name: Build SQLCipher Multi-Platform

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [created]
  workflow_dispatch:

jobs:
  build-macos:
    name: Build macOS (${{ matrix.arch }})
    runs-on: macos-latest
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64, arm64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew update
          brew install openssl@3 tcl-tk

      - name: Configure environment
        run: |
          # Find OpenSSL installation
          if [ -d "/opt/homebrew/opt/openssl@3" ]; then
            echo "OPENSSL_ROOT_DIR=/opt/homebrew/opt/openssl@3" >> $GITHUB_ENV
          elif [ -d "/usr/local/opt/openssl@3" ]; then
            echo "OPENSSL_ROOT_DIR=/usr/local/opt/openssl@3" >> $GITHUB_ENV
          fi

      - name:  Verify OpenSSL installation
        run:  |
          echo "OpenSSL location: $OPENSSL_ROOT_DIR"
          ls -la $OPENSSL_ROOT_DIR/lib/ || true
          ls -la $OPENSSL_ROOT_DIR/include/ || true
          
          # Test if crypto library exists
          if [ -f "$OPENSSL_ROOT_DIR/lib/libcrypto.dylib" ] || [ -f "$OPENSSL_ROOT_DIR/lib/libcrypto.a" ]; then
            echo "✅ OpenSSL crypto library found"
          else
            echo "❌ OpenSSL crypto library NOT found"
            exit 1
          fi

      - name: Build SQLCipher
        env:
          ARCH: ${{ matrix.arch }}
        run: |
          # Export OpenSSL paths
          export PKG_CONFIG_PATH="${OPENSSL_ROOT_DIR}/lib/pkgconfig:${PKG_CONFIG_PATH}"
          export LDFLAGS="-L${OPENSSL_ROOT_DIR}/lib"
          export CPPFLAGS="-I${OPENSSL_ROOT_DIR}/include"
          export CFLAGS="-I${OPENSSL_ROOT_DIR}/include"
          
          # Show environment for debugging
          echo "PKG_CONFIG_PATH: $PKG_CONFIG_PATH"
          echo "LDFLAGS: $LDFLAGS"
          echo "CPPFLAGS: $CPPFLAGS"
          
          chmod +x build-macos.sh
          ./build-macos.sh

      - name:  Verify build output
        run: |
          ls -lah build/macos-${{ matrix.arch }}/lib/ || true
          ls -lah build/macos-${{ matrix.arch }}/include/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sqlcipher-macos-${{ matrix.arch }}
          path: |
            build/macos-${{ matrix.arch }}/lib/*.a
            build/macos-${{ matrix.arch }}/include/*.h
          retention-days: 30

  build-linux:
    name: Build Linux (${{ matrix.arch }})
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            cc: gcc
            cflags:  "-m64"
          - arch: arm64
            cc: aarch64-linux-gnu-gcc
            cflags: ""
          - arch: armv7
            cc: arm-linux-gnueabihf-gcc
            cflags:  ""

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name:  Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev tcl
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu
          elif [ "${{ matrix.arch }}" = "armv7" ]; then
            sudo apt-get install -y gcc-arm-linux-gnueabihf
          fi

      - name: Build SQLCipher
        env:
          ARCH: ${{ matrix.arch }}
          CC: ${{ matrix.cc }}
          CFLAGS: ${{ matrix.cflags }}
        run: |
          chmod +x build-linux.sh
          ./build-linux.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sqlcipher-linux-${{ matrix.arch }}
          path: |
            build/linux-${{ matrix.arch }}/lib/*.a
            build/linux-${{ matrix.arch }}/include/*.h
          retention-days: 30

  build-windows:
    name: Build Windows (${{ matrix.arch }})
    runs-on: windows-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            msys_arch: x86_64
          - arch: x86
            msys_arch: i686

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MSYS2
        uses:  msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            mingw-w64-${{ matrix.msys_arch }}-gcc
            mingw-w64-${{ matrix.msys_arch }}-openssl
            mingw-w64-${{ matrix.msys_arch }}-tcl
            make
            curl
            tar

      - name: Build SQLCipher
        shell: msys2 {0}
        env:
          ARCH: ${{ matrix.arch }}
        run: |
          chmod +x build-windows.sh
          ./build-windows.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sqlcipher-windows-${{ matrix.arch }}
          path: |
            build/windows-${{ matrix.arch }}/lib/*.a
            build/windows-${{ matrix.arch }}/include/*.h
          retention-days: 30

  create-release-assets:
    name: Create Release Assets
    needs: [build-macos, build-linux, build-windows]
    runs-on:  ubuntu-latest
    if: github.event_name == 'release'

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release packages
        run: |
          cd artifacts
          for dir in */; do
            dirname="${dir%/}"
            tar -czf "${dirname}.tar.gz" -C "$dirname" .
          done

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files:  artifacts/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}