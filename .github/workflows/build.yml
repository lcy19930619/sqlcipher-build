name: build-sqlcipher

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - os: ubuntu-22.04
            arch: amd64
            host: x86_64-linux-gnu
          - os: ubuntu-22.04
            arch: arm64
            host: aarch64-linux-gnu
          # macOS 15
          - os: macos-15-intel
            arch: amd64
            host: x86_64-apple-darwin
          - os: macos-15
            arch: arm64
            host: aarch64-apple-darwin
          # Windows (MSYS2 mingw)
          - os: windows-latest
            arch: x64
            msys-env: mingw64
            host: x86_64-w64-mingw32
          - os: windows-latest
            arch: x86
            msys-env: mingw32
            host: i686-w64-mingw32

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      # ---------- Linux deps (fix arm64 sources 404) ----------
      - name: Fix apt sources and install deps (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo dpkg --add-architecture arm64
          sudo tee /etc/apt/sources.list >/dev/null <<'EOF'
          deb [arch=amd64] http://archive.ubuntu.com/ubuntu jammy main restricted universe multiverse
          deb [arch=amd64] http://archive.ubuntu.com/ubuntu jammy-updates main restricted universe multiverse
          deb [arch=amd64] http://archive.ubuntu.com/ubuntu jammy-backports main restricted universe multiverse
          deb [arch=amd64] http://security.ubuntu.com/ubuntu jammy-security main restricted universe multiverse
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy main restricted universe multiverse
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy-updates main restricted universe multiverse
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy-backports main restricted universe multiverse
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy-security main restricted universe multiverse
          EOF
          sudo apt-get update
          sudo apt-get install -y \
            build-essential pkg-config tcl git \
            crossbuild-essential-arm64 libc6-dev-arm64-cross \
            libssl-dev libssl-dev:arm64 \
            qemu-user-static

      # ---------- macOS deps ----------
      - name: Install deps (macOS)
        if: startsWith(matrix.os, 'macos')
        run: |
          brew update
          brew install openssl@3 tcl-tk pkg-config
          OPENSSL_PREFIX="$(brew --prefix openssl@3)"
          echo "OPENSSL_PREFIX=$OPENSSL_PREFIX" >> $GITHUB_ENV
          echo "MACOSX_DEPLOYMENT_TARGET=10.15" >> $GITHUB_ENV

      # ---------- Windows deps (MSYS2 + mingw) ----------
      - name: Set up MSYS2
        if: startsWith(matrix.os, 'windows')
        uses: msys2/setup-msys2@v2
        with:
          update: true
          msystem: ${{ matrix.msys-env }}
          install: >-
            git
            autoconf
            automake
            libtool
            make
            perl
            mingw-w64-${{ matrix.arch == 'x64' && 'x86_64' || 'i686' }}-toolchain
            mingw-w64-${{ matrix.arch == 'x64' && 'x86_64' || 'i686' }}-binutils
            mingw-w64-${{ matrix.arch == 'x64' && 'x86_64' || 'i686' }}-pkg-config

      - name: Prepare env
        shell: bash
        run: |
          echo "HOST=${{ matrix.host }}" >> $GITHUB_ENV
          echo "PREFIX=$PWD/out/${{ matrix.os }}-${{ matrix.arch }}" >> $GITHUB_ENV
          mkdir -p out/${{ matrix.os }}-${{ matrix.arch }}

      - name: Fetch SQLCipher
        shell: bash
        run: |
          mkdir -p deps && cd deps
          if [ ! -d sqlcipher ]; then
            git clone https://github.com/sqlcipher/sqlcipher.git
          fi
          cd sqlcipher
          git checkout v4.5.6

      # ---------- Build OpenSSL static (Unix) ----------
      - name: Build OpenSSL static (Unix)
        if: ${{ !startsWith(matrix.os, 'windows') }}
        shell: bash
        env:
          PREFIX: ${{ env.PREFIX }}
          HOST: ${{ env.HOST }}
        run: |
          set -e
          mkdir -p deps && cd deps
          if [ ! -d openssl-src ]; then
            git clone --depth=1 --branch=openssl-3.2.1 https://github.com/openssl/openssl.git openssl-src
          fi
          cd openssl-src
          if [[ "$OSTYPE" == darwin* ]]; then
            TARGET=$([[ "${{ matrix.arch }}" == "arm64" ]] && echo "darwin64-arm64-cc" || echo "darwin64-x86_64-cc")
            ./Configure no-shared no-dso $TARGET --prefix="${PREFIX}/openssl-static" -mmacosx-version-min=10.15
            make -j$(sysctl -n hw.ncpu)
          else
            if [[ "$HOST" == "aarch64-linux-gnu" ]]; then
              export CC=aarch64-linux-gnu-gcc
              ./Configure linux-aarch64 no-shared no-dso --prefix="${PREFIX}/openssl-static"
            else
              ./Configure linux-x86_64 no-shared no-dso --prefix="${PREFIX}/openssl-static"
            fi
            make -j$(nproc)
          fi
          make install_sw

      # ---------- Configure & Build on Linux/macOS ----------
      - name: Configure & Build (Unix)
        if: ${{ !startsWith(matrix.os, 'windows') }}
        working-directory: deps/sqlcipher
        env:
          PREFIX: ${{ env.PREFIX }}
          HOST: ${{ env.HOST }}
        shell: bash
        run: |
          if [[ "$OSTYPE" == darwin* ]]; then
            BUILD_TRIPLE=$([[ "${{ matrix.arch }}" == "arm64" ]] && echo "aarch64-apple-darwin" || echo "x86_64-apple-darwin")
            export PKG_CONFIG_PATH="${PREFIX}/openssl-static/lib/pkgconfig"
            export CPPFLAGS="-I${PREFIX}/openssl-static/include -mmacosx-version-min=10.15"
            export LDFLAGS="-L${PREFIX}/openssl-static/lib -mmacosx-version-min=10.15"
            TCL_OPT="--disable-tcl"
          else
            BUILD_TRIPLE=$(gcc -dumpmachine)
            export PKG_CONFIG_PATH="${PREFIX}/openssl-static/lib/pkgconfig"
            export CPPFLAGS="-I${PREFIX}/openssl-static/include"
            export LDFLAGS="-L${PREFIX}/openssl-static/lib"
            TCL_OPT=""
            if [[ "$HOST" == "aarch64-linux-gnu" ]]; then
              export CC=aarch64-linux-gnu-gcc
              export CXX=aarch64-linux-gnu-g++
              export AR=aarch64-linux-gnu-ar
              export RANLIB=aarch64-linux-gnu-ranlib
            fi
          fi

          cfg_opts=(
            --build="${BUILD_TRIPLE}"
            --host="${HOST}"
            --prefix="${PREFIX}"
            --enable-tempstore=yes
            --enable-static=yes
            --disable-shared
            --with-crypto-lib=openssl
          )
          if [[ -n "$TCL_OPT" ]]; then cfg_opts+=("$TCL_OPT"); fi

          ./configure "${cfg_opts[@]}" \
            CFLAGS="-DSQLITE_HAS_CODEC -DSQLITE_TEMP_STORE=2" \
            CPPFLAGS="$CPPFLAGS" \
            LDFLAGS="$LDFLAGS" \
            LIBS="$(PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --libs openssl)"
          make -j$(nproc 2>/dev/null || sysctl -n hw.ncpu)
          make install

      # ---------- Windows: Build OpenSSL static ----------
      - name: Build OpenSSL static (Windows)
        if: startsWith(matrix.os, 'windows')
        shell: msys2 {0}
        env:
          PREFIX: ${{ env.PREFIX }}
        run: |
          set -e
          MINGW_PREFIX="/mingw${{ matrix.arch == 'x64' && '64' || '32' }}"
          export PATH="${MINGW_PREFIX}/bin:$PATH"
          mkdir -p deps && cd deps
          if [ ! -d openssl-src ]; then
            git clone --depth=1 --branch=openssl-3.2.1 https://github.com/openssl/openssl.git openssl-src
          fi
          cd openssl-src
          TARGET=$([[ "${{ matrix.arch }}" == "x64" ]] && echo "mingw64" || echo "mingw")
          ./Configure no-shared no-dso $TARGET --prefix="${PREFIX}/openssl-static"
          make -j$(nproc || 2)
          make install_sw

      # ---------- Windows-specific steps ----------
      - name: Normalize line endings (Windows)
        if: startsWith(matrix.os, 'windows')
        shell: msys2 {0}
        working-directory: deps/sqlcipher
        run: |
          find . -type f \( -name 'VERSION' -o -name 'configure.ac' -o -name 'configure' -o -name 'sqlite3.h' -o -name 'Makefile.am' -o -name 'Makefile.in' \) -exec sed -i 's/\r$//' {} +

      - name: Regenerate configure (Windows)
        if: startsWith(matrix.os, 'windows')
        shell: msys2 {0}
        working-directory: deps/sqlcipher
        run: |
          set -e
          autoreconf -fiv

      - name: Configure & Build (Windows mingw)
        if: startsWith(matrix.os, 'windows')
        shell: msys2 {0}
        working-directory: deps/sqlcipher
        env:
          PREFIX: ${{ env.PREFIX }}
          HOST: ${{ env.HOST }}
        run: |
          set -e
          export CONFIG_SITE=/dev/null
          MINGW_PREFIX="/mingw${{ matrix.arch == 'x64' && '64' || '32' }}"
          export PATH="${MINGW_PREFIX}/bin:$PATH"
          export CC=${MINGW_PREFIX}/bin/${HOST}-gcc
          export AR=${MINGW_PREFIX}/bin/${HOST}-gcc-ar
          export RANLIB=${MINGW_PREFIX}/bin/${HOST}-gcc-ranlib
          export STRIP=${MINGW_PREFIX}/bin/${HOST}-strip
          export PKG_CONFIG_PATH="${PREFIX}/openssl-static/lib/pkgconfig"
          export CPPFLAGS="-I${PREFIX}/openssl-static/include"
          export LDFLAGS="-L${PREFIX}/openssl-static/lib"
          TCL_OPT="--disable-tcl"
          cfg_opts=(
            --host="${HOST}"
            --prefix="${PREFIX}"
            --enable-tempstore=yes
            --enable-static=yes
            --disable-shared
            --with-crypto-lib=openssl
            $TCL_OPT
          )

          ./configure "${cfg_opts[@]}" \
            CFLAGS="-DSQLITE_HAS_CODEC -DSQLITE_TEMP_STORE=2" \
            CPPFLAGS="$CPPFLAGS" \
            LDFLAGS="$LDFLAGS" \
            LIBS="$(PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --libs openssl)"
          make -j$(nproc || 2)
          make install

      - name: Package artifacts
        shell: bash
        run: |
          ls -R "${PREFIX}"
          tar czf sqlcipher-${{ matrix.os }}-${{ matrix.arch }}.tar.gz -C "${PREFIX}" .
          mkdir -p artifacts
          mv sqlcipher-${{ matrix.os }}-${{ matrix.arch }}.tar.gz artifacts/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sqlcipher-${{ matrix.os }}-${{ matrix.arch }}
          path: artifacts/sqlcipher-${{ matrix.os }}-${{ matrix.arch }}.tar.gz